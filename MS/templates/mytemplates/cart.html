{% extends 'mytemplates/index.html' %}
{% load static %}
{% block content %}
<div style="max-width: 900px; margin: auto; padding: 40px 20px;">
  <h2 style="text-align:center;">ðŸ›’ Your Cart</h2>

  {% if cart_items %}
  <form method="POST" action="{% url 'update_cart' %}" id="cartForm">
    {% csrf_token %}
    <div style="margin-top: 30px;">
      {% for item in cart_items %}
      <div id="item-{{ item.id }}" style="display: flex; align-items: center; margin-bottom: 20px; border: 1px solid #ccc; padding: 15px; border-radius: 10px;">
        <img src="{{ item.product.image.url }}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; margin-right: 20px;">

        <div style="flex: 1;">
          <h4>{{ item.product.product_name }}</h4>
          <p>Price: Rs {{ item.product.price }}</p>

          <label>Qty:
            <input type="number" name="quantity_{{ item.id }}" min="1" value="{{ item.quantity }}" data-price="{{ item.product.price }}"
                   class="quantity-input" style="width: 60px; padding: 4px;">
          </label>

          <label>Size:
            <select name="size_{{ item.id }}" required style="margin-left: 10px;">
              <option value="">--Select--</option>
              {% for s in size_choices %}
              <option value="{{ s }}" {% if item.size == s %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
          </label>
        </div>

        <!-- âœ… Remove form outside -->
        <div>
          <form method="POST" action="{% url 'remove_cart_item' item.id %}">
            {% csrf_token %}
            <button type="submit"
                    onclick="return confirm('Remove this item?')"
                    style="background: crimson; color: white; border: none; padding: 6px 12px; border-radius: 6px;">
              Remove
            </button>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Coupon -->
    <div style="margin-top: 30px;">
      <label for="coupon">Have a coupon?</label>
      <input type="text" name="coupon" id="coupon" placeholder="Enter code (optional)" style="padding: 6px; margin-left: 10px;">
    </div>

    <!-- Summary & Proceed -->
    <div style="margin-top: 20px;">
      <h4>Total: Rs <span id="total-price">{{ total_price|floatformat:2 }}</span></h4>
      {% if discount_amount %}
        <p style="color: green;">Discount: Rs {{ discount_amount }}</p>
        <h5 style="color: #2a2a2a;">Final Total: Rs {{ final_price|floatformat:2 }}</h5>
      {% endif %}
      <button type="button" onclick="showConfirmModal()"
              style="margin-top: 10px; background: #28a745; color: white; padding: 10px 20px; border-radius: 6px;">
        Proceed to Checkout
      </button>
    </div>
  </form>

  {% else %}
  <div style="text-align:center; margin-top: 50px;">
    <img src="{% static 'images/empty-cart.png' %}" style="max-width: 200px;">
    <h3>Your cart is empty</h3>
    <a href="{% url 'product' %}" style="padding: 10px 20px; background: black; color: white; text-decoration: none; border-radius: 8px;">Start Shopping</a>
  </div>
  {% endif %}
</div>

<!-- âœ… Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-4">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Order</h5>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to place this order?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="cartForm" class="btn btn-success">Yes, Proceed</button>
      </div>
    </div>
  </div>
</div>

<!-- âœ… JavaScript for Total Update -->
<script>
  function updateTotal() {
    let total = 0;
    document.querySelectorAll('.quantity-input').forEach(input => {
      const price = parseFloat(input.dataset.price);
      const qty = parseInt(input.value);
      if (!isNaN(price) && !isNaN(qty)) total += price * qty;
    });
    document.getElementById('total-price').innerText = total.toFixed(2);
  }

  document.querySelectorAll('.quantity-input').forEach(input => {
    input.addEventListener('input', updateTotal);
  });

  function showConfirmModal() {
    new bootstrap.Modal(document.getElementById('confirmModal')).show();
  }

  updateTotal();
</script>
{% endblock %}
